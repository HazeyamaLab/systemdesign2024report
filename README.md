# 情報システム設計 Webアプリケーション開発課題 開発環境（提出用）

このリポジトリは、情報システム設計（東京学芸大学 教育学部 情報教育教室開設科目）のWebアプリケーション開発課題に用いる開発環境のテンプレートです。

## 🧭 Quick Links

- [開発環境の**使い方**（この文書）](./README.md)
    - [⏯️ 開発したアプリケーションを起動する](#️-開発したアプリケーションを起動する)
    - [🗄️ データベース管理システムを操作する](#️-データベース管理システムを操作する)
- 開発コンテナーの作成方法、開発コンテナーへの**接続方法**、開発環境に起因するトラブルの対処法
    - [🪟 Windowsセルフホスト用](./docs/setup/procedure-for-selfhost-windows.md)
    - [🍎 macOSセルフホスト用](./docs/setup/procedure-for-selfhost-macos.md)
    - [📡 リモート開発環境利用者用](./docs/setup/procedure-for-hrde-user.md)
- [やることリスト](docs/development/todo.md)

## ℹ️ 開発環境の使い方

この開発環境は開発コンテナーとして構築されています。
開発コンテナーの作成方法および開発コンテナーへの接続方法については[docs/setup/index.md](docs/setup/index.md)をご覧ください。

### 📦 開発コンテナーに含まれているもの

開発コンテナーは次の3つのコンテナーから構成されています。

- `devcontainer`：Java開発キット等のWebアプリの開発に必要なツールがインストールされていて、ソースコードの読み書きもできるメインのコンテナーです。ソースコードの編集、開発したアプリケーションのビルドや起動等の作業のほとんどは、VSCodeを通してこのコンテナー上で行うことになります。
- `mysql`：MySQLがインストールされているコンテナーです。`devcontainer`と`mysql`の間は通信できるようになっているので、開発したアプリケーションをテスト・実演する際は、このコンテナー上のデータベースを読み書きすることになります。
- `adminer`：MySQLのWebUIを提供するAdminerがインストールされているコンテナーです。`adminer`と`mysql`の間は通信できるようになっていて、WebUIで`mysql`コンテナー上のデータベースを読み書きすることができます。

### ⏯️ 開発したアプリケーションを起動する

#### ⌨️ ターミナルから直接起動する場合

- **👉 起動手順**：[VSCodeのターミナル](#️-vscodeのターミナルを使う)で次のコマンドを実行します。開発したアプリケーションがビルドされ、サーブレットコンテナ（サーブレットの仕様に沿って開発されたアプリケーションを実行するための仕組み）が起動します。
    ```sh
    ./gradlew appRun
    ```
- **手元のPCのブラウザでテストや実演を行う**：開発コンテナー上の`localhost:8080`を手元のPCの`localhost:8080`に[転送](#-開発コンテナー上のポートを手元のpcのポートに転送する)し、ブラウザで http://localhost:8080/systemdesign2024report にアクセスしてください。
- **アプリケーションを停止する**：VSCodeのターミナルで`Ctrl+C`（macOSは`^C`）を入力します。
- **自動再ビルド・再起動**：アプリケーションの実行中にコードを変更した場合、アプリケーションの再ビルド、サーブレットコンテナの再起動が自動的に行われます。手動で行う必要はありません。

#### 🩺 VSCodeのデバッグ機能を使って起動する場合

- **👉 起動手順**
    1. `Ctrl+Shift+P`（macOSは`⇧⌘P`）でコマンドパレットを開き、`Debug: Start Debugging`と入力して`Enter`キーを押します（途中まで入力して同名の項目を選択しても構いません）。
    2. `The task 'デバッグ' cannot be tracked.`（`タスク 'デバッグ' を追跡できません。`）と警告が表示された場合は、`Debug anyway`（`このままデバッグ`）をクリックします。
    3. 開発コンテナー接続後の初回起動時は、デバッガーの接続に時間がかかり`Failed to attach to remote debuggee VM. Reason: java.net.ConnectException: Connection refused`というエラーが表示されることがあります。この場合、`Cancel`（`キャンセル`）ボタンをクリックしてエラーダイアログを閉じて、再度手順1からやり直してください。
    3. 開発したアプリケーションがビルドされ、サーブレットコンテナが起動します。ビルドとサーブレットコンテナの起動に成功すると、画面下部のステータスバーの色が変わり、デバッグモードに入ります。
- **手元のPCのブラウザでテストや実演を行う**：開発コンテナー上の`localhost:8080`を手元のPCの`localhost:8080`に転送し、ブラウザで http://localhost:8080/systemdesign2024report にアクセスしてください。
- **デバッグモードの機能を使う**：この方法で起動した場合は、コードにブレークポイントを設定して、ブレークポイント設定箇所の実行が開始されたタイミングからステップ実行させることができます。標準出力および標準エラー出力の内容は[パネルの`Terminal`タブ](#️-vscodeのターミナルを使う)で確認することができます。`Debug Console`タブには表示されません。
- **アプリケーションを停止する**：画面上部のツールバーの`Disconnect`（`切断`）ボタンをクリックします。
- **自動再ビルド・再起動**：アプリケーションの実行中にコードを変更した場合、アプリケーションの再ビルド、サーブレットコンテナの再起動が自動的に行われます。手動で行う必要はありません。

### 🗄️ データベース管理システムを操作する

`mysql`コンテナーにはデータベース管理システム・MySQLがインストールされていて、MySQLサーバが実行されています。
`devcontainer`コンテナーから接続する場合のMySQLサーバへの接続情報は次の通りです。

- ホスト名: `mysql`
- ポート番号: `3306`
- ユーザ名: `mysql`
- パスワード: `password`

#### ⌨️ CLIで操作する場合

`devcontainer`コンテナーにはMySQLクライアントがインストールされています。[VSCodeのターミナル](#️-vscodeのターミナルを使う)で`mysql`コンテナー上のデータベースを操作することができます。

- **MySQLサーバにログインする**
    1. VSCodeのターミナルで次のコマンドを実行し、MySQLサーバにログインします。パスワードの入力を求められた場合は、パスワード（`password`）を入力して`Enter`キーを押します。なお、コマンドの`-h`オプションはホスト名を、`-u`オプションはユーザ名を、`-p`オプションはパスワードを設定するためのものです。
        ```sh
        mysql -h mysql -u mysql -p
        ```
    2. ログインに成功するとプロンプトが`MySQL [(none)]>`に変わり、SQLを実行することができるようになります。
- **MySQLサーバからログアウトする**：MySQLサーバからログアウトする際は、MySQLにログインしている状態で`exit`と入力して`Enter`キーを押します。
- **rootユーザとしてログインする**：データベースを作成したり、ユーザに権限を付与したりするためには、`root`ユーザとしてログインする必要があります。`root`ユーザとしてログインする場合は、`-u mysql`を`-u root`に変えて上記のコマンドを実行してください。

#### 🖱️ Adminerで操作する場合

開発コンテナー上の`adminer:8080`を手元のPCの`localhost:8081`に[転送](#-開発コンテナー上のポートを手元のpcのポートに転送する)し、ブラウザで http://localhost:8081 にアクセスしてください。
ログイン画面が表示された場合は、次の情報を入力してログインしてください。

- `サーバ`: `mysql`
- `ユーザ名`: `mysql`
- `パスワード`: `password`

#### 💻 手元のPCにインストールされているツールで操作する

開発コンテナー上の`mysql:3306`を手元のPCのポート（例えば`localhost:3306`）に[転送](#-開発コンテナー上のポートを手元のpcのポートに転送する)し、お使いのツールで転送先のアドレス・ポートにログインしてください。

- `サーバ`: 転送先のアドレス・ポートをお使いください。
- `ユーザ名`: `mysql`
- `パスワード`: `password`

## ℹ️ VSCodeおよび開発コンテナーの操作方法

### ⌨️ VSCodeのターミナルを使う

VSCodeにはターミナルが内蔵されています。
通常時は手元のPCのシェル上でコマンドを実行することができ、OSに付属のターミナルと同じように使うことができます。
しかし、開発コンテナーに接続している場合は、開発コンテナー上のシェルでコマンドを実行することができます。
開発コンテナー上のシェルでコマンドを実行する際は、VSCodeのターミナルを使用してください。

👉 VSCodeのターミナルを表示させるには次の方法があります。

- `Ctrl+@`キー（macOSでは`` ^` ``キー）を押す。
- パネルを表示して（`Ctrl+J`（macOSでは`⌘J`）キーを押すか、画面上部のメニューバーの`View`（`表示`）→`Appearance`（`外観`）→`Panel`（`パネル`）をクリックする）、パネルの`Terminal`（`ターミナル`）タブをクリックする。

### 📡 開発コンテナー上のポートを手元のPCのポートに転送する

Webアプリケーションを構成するコンポーネント（アプリケーション本体、データベース管理システム等）同士が通信を行う際は、よくTCP/IPプロトコルスタックが用いられます。
TCP/IPプロトコルスタックでは、あるコンポーネントに対して通信を行う際は、そのコンポーネントがlistenしているネットワークインターフェース（今回はコンテナー）に与えられたIPアドレスまたはホスト名と、ポート番号を指定します。
しかし、手元のPCとコンテナーのネットワークは切り離されている（相互にunreachableである）ため、手元のPCからコンテナーに直接通信を行うことはできません。

VSCodeには、手元のPCのあるポートへの通信を、開発コンテナー上およびそれと通信できるコンテナー上のポートへの通信とみなして、手元のPCからコンテナー上で実行されているコンポーネントに通信できるようにする「ポート転送」という機能が用意されています。

👉 次の方法で、開発コンテナー上のポートを手元のPCのポートに転送することができます。

1. ポート転送設定の画面を表示させます。
    1. 画面下部にパネルを表示させます。`Ctrl+J`（macOSでは`⌘J`）キーを押すか、画面上部のメニューバーの`View`（`表示`）→`Appearance`（`外観`）→`Panel`（`パネル`）をクリックします。
    2. 画面下部のパネルの`Ports`（`ポート`）タブをクリックします。
2. ポート転送設定を追加します。
    1. `Add Port`（`ポートの追加`）ボタンをクリックします。
    2. 手元のPCからアクセスできるようにしたい、コンテナー上のポート番号またはホスト名とポート番号（`ホスト名:ポート番号`の形式で）を入力して`Enter`キーを押します。
    3. 入力欄の右側に、手元のPC上のどのアドレスにポートを転送したのかが表示されます。`Ctrl`キー（macOSの場合は`⌘`キー）を押しながらクリックすると、ブラウザでそのアドレスにアクセスすることができます。また、転送先のポート番号を変更したい場合は、それを右クリックして`Change Local Address Port`（`ローカル アドレス ポートの変更`）をクリックして、新しい転送先のポート番号を入力します。ただし、PC上の一つのポートに複数のコンテナー上のポートを転送することはできないので注意してください。

## ✉️ お問い合わせ先

この開発環境のテンプレートに関する質問やお問い合わせの際は、`e215413x[at]st.u-gakugei.ac.jp`に大学メールまたはTeamsチャットでご連絡ください。（特定電子メールの送信の適正化等に関する法律に基づく表記：このメールアドレスへの特定電子メールの送信を拒否いたします。）

学外の方からの質問やお問い合わせにはお答えできません。
